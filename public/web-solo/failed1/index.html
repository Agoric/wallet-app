<!DOCTYPE html>
<html>
  <head>
    <link rel="manifest" href="../manifest.json" />
    <link rel="icon" type="image/png" href="../images/touch/homescreen144.png" />
    <title>Agoric Wallet App</title>
  </head>
  <body>
    <h1>Failed 1</h1>
    <p>Verdict: FAILED! Table at the end of <a
    href="https://html.spec.whatwg.org/#integration-with-the-javascript-agent-cluster-formalism">HTML
    spec</a> says that SharedWorkers are not in the same agent cluster as the
    window, so can't communicate via SharedArrayBuffer.</p>
    <img src="failed1.svg" width="300px" height="300px"/>
    <div id="spinner"></div>
    <button id="getCount">Increment Count</button> <span id="currentCount"></span>
    <script type="module">
      import '@agoric/wallet/components/install-ses-lockdown.js';
      if (!self.crossOriginIsolated) {
        const msg = `web-solo requires self.crossOriginIsolated`;
        alert(msg);
        throw Error(msg);
      }
      let spin = 0;
      const spinText = ['/', '-', '\\', '|'];
      setInterval(() => {
        spinner.innerText = spinText[spin];
        spin = (spin + 1) % spinText.length;
      }, 1000 / spinText.length);

      const ss = new SharedWorker('./swingset-worker.js');
      const store = new SharedWorker('./store-worker.js');
      ss.port.addEventListener('message', ev => {
        console.log('received from swingset', ...ev.data);
        switch (ev.data[0]) {
          case 'count': {
            currentCount.innerText = ev.data[1];
            break;
          }
          case 'toDapp': {
            window.parent.postMessage(ev.data, '*');
            break;
          }
        }
      });
      ss.port.start();
      store.port.start();
      const channel = new MessageChannel();

      // We transfer the store directly to the swingset.
      ss.port.postMessage(['initStore', store.port], [store.port]);
      getCount.addEventListener('click', ev => {
        ss.port.postMessage(['getCount']);
      });

      window.addEventListener('message', ev => {
        switch (ev.data[0]) {
          case 'fromDapp': {
            ss.port.postMessage(ev.data);
            break;
          }
        }
      });
    </script>
  </body>
</html>
